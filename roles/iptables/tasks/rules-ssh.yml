---
- name: check if knockd conf exists
  stat:
    path: /etc/knockd.conf
  register: knockd_conf

- name: check if dport 22 is managed by knockd
  lineinfile:
    path: /etc/knockd.conf
    regexp: "dport 22"
    state: present
  check_mode: true
  become: true
  register: is_dport_22_managed
  failed_when: is_dport_22_managed is changed
  when: knockd_conf.stat.exists

- name: firewall rule - allow incoming SSH
  iptables:
    chain: INPUT
    protocol: tcp
    destination_port: "22"
    ctstate: NEW,ESTABLISHED
    jump: ACCEPT
  become: true
  when: is_dport_22_managed.skipped is defined and is_dport_22_managed.skipped

- name: firewall rule - allow outgoing SSH
  iptables:
    chain: OUTPUT
    protocol: tcp
    source_port: "22"
    ctstate: ESTABLISHED
    jump: ACCEPT
  become: true
